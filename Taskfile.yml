version: '3'

vars:
  PROJECT_NAME: vulcan-ci

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list

  lint:
    desc: Run clippy linter with warnings as errors
    cmds:
      - cargo clippy --workspace -- -D warnings

  fmt:
    desc: Format code with rustfmt
    cmds:
      - cargo fmt --all

  fmt-check:
    desc: Check if code is formatted correctly
    cmds:
      - cargo fmt --all -- --check

  check:
    desc: Fast compile check without building
    cmds:
      - cargo check --workspace

  test:
    desc: Run all tests
    cmds:
      - cargo test --workspace

  build:
    desc: Build the project in debug mode
    cmds:
      - cargo build --workspace

  release:
    desc: Build the project in release mode
    cmds:
      - cargo build --workspace --release

  clean:
    desc: Clean build artifacts
    cmds:
      - cargo clean

  all:
    desc: Format, lint, and build the project
    deps:
      - fmt
      - lint
      - build
    cmds:
      - echo "All checks passed!"

  ci:
    desc: Run CI checks (format check, lint, test, build)
    deps:
      - fmt-check
      - lint
      - test
      - build
    cmds:
      - echo "CI checks passed!"

  # Service run tasks
  run-api:
    desc: Run the API service
    cmds:
      - cargo run --package vulcan-api

  run-metrics-api:
    desc: Run the Metrics API service
    cmds:
      - cargo run --package vulcan-metrics-api

  run-worker:
    desc: Run the Worker service
    cmds:
      - cargo run --package vulcan-worker

  run-worker-orchestrator:
    desc: Run the Worker Orchestrator service
    cmds:
      - cargo run --package vulcan-worker-orchestrator

  run-chain-parser:
    desc: Run the Chain Parser service
    cmds:
      - cargo run --package vulcan-chain-parser

  run-workflow-trigger-processor:
    desc: Run the Workflow Trigger Processor service
    cmds:
      - cargo run --package vulcan-workflow-trigger-processor

  # Database tasks
  db-up:
    desc: Start the PostgreSQL database
    cmds:
      - docker compose up -d --wait
      - docker compose ps

  db-down:
    desc: Stop the PostgreSQL database
    cmds:
      - docker compose down

  db-reset:
    desc: Reset the database (stop, remove volume, start fresh)
    cmds:
      - docker compose down -v
      - docker compose up -d --wait
      - diesel migration run

  db-migrate:
    desc: Run pending database migrations
    cmds:
      - diesel migration run

  db-migrate-redo:
    desc: Redo the last migration
    cmds:
      - diesel migration redo

  db-psql:
    desc: Open psql shell to the database
    cmds:
      - docker compose exec postgres psql -U vulcan -d vulcan_ci
